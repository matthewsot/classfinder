@using Classfinder.Database;
@{
    ViewBag.Title = ViewBag.Username == null ? "" : ViewBag.Username + "'s Schedule";
    if(WebSecurity.IsAuthenticated) {
        Layout = "~/Views/Shared/_MainLayout.cshtml";
    }
    else {
        Layout = "~/Views/Shared/_TopNav.cshtml";
    }
}
@if(!WebSecurity.IsAuthenticated) {
@section Nav {
    <ul class="navList" id="mainNavList">
        <li><a href="~/FAQ">faq</a></li>
        <li><a href="~/Contact">contact</a></li>
        <li><a href="http://blog.classfinder.me/">tumblr</a></li>
        <li style="border-right:1px solid;"><a href="~/">signup/login</a></li>
    </ul>
}
}

@section Head {
    <script src="~/Scripts/Shared/Scaler.js"></script>
    <script src="~/Scripts/jQuery/jquery.signalR-1.1.1.min.js" type="text/javascript"></script>
    <link href="~/Styles/Home/Index/Default.css" type="text/css" rel="stylesheet" />
}
<div id="schedDiv">
    <h1 id="NowViewing">@(ViewBag.Username)'s Schedule (Loading...)</h1>
    <div id="firstSem">
        Loading...
    </div><br/>
    <div id="secondSem">
        Loading...
    </div>
</div>
<div id="floatingOptions" style="position:fixed;top:100px;right:20px;">
    @if (WebSecurity.IsAuthenticated)
    {
        <a href="~/Account/Classes">Manage Your Classes</a><br />
    }
    <a href="http://blog.classfinder.me/">Follow us on Tumblr!</a>
</div>
<script src="~/signalr/hubs" type="text/javascript"></script>
<script type="text/javascript">
    var parts = location.pathname.split('/');
    var toUsername = "";
    if (parts.length >= 3) {
        toUsername = unescape(parts[2]);
    }
    else if (username != null) {
        toUsername = Username;
    }
    function MakeMobile() { //you're welcome, Alex xD
        MinTop();
        $("#firstSem").css({
            "position": "relative",
            "float": "none",
            "left": "auto",
            "top": "auto"
        });
        $("#secondSem").css({
            "position": "relative",
            "float": "none",
            "right": "auto",
            "top": "auto"
        });
        $('#floatingOptions').hide();
    }
    var isMobile = @ViewBag.Mobile.ToString().ToLower();
    if(isMobile) {
        MakeMobile();
    }
    /* <SignalR stuff> */
    classInfo = $.connection.classInfo;
    $.connection.hub.start().done(function () {
        if (toUsername != "") {
            GetPeers(toUsername);
        }
        else {
            if(!isMobile) {
                window.location.href = "http://classfinder.me/";
            }
            else {
                window.location.href = "http://classfinder.me/mobile";
            }
        }
    });
    function GetPeers(UsrNm) {
        $("#firstSem").html("<h2>First Semester:</h2>");
        $("#secondSem").html("<h2>Second Semester:</h2>");
        classInfo.server.getPeers(UsrNm).done(function (PeerList) {
            $("#NowViewing").text(PeerList[0] + "'s Schedule");
            for (var i = 1; i < PeerList.length; i++) { //[0] is the person's name
                AddPeers(PeerList[i]);
            }
        });
    }
    /* </SignalR stuff> */
    function AddPeers(List) {
        for (var i = 0; i < List.length; i++) {
            var currClass = List[i];
            var classDiv = document.createElement("div");
            var className = document.createElement("h3");
            className.textContent = currClass.Period + " - " + currClass.Name + " (" + currClass.Teacher + ")";
            classDiv.appendChild(className);

            var peers = document.createElement("ul");
            peers.style.listStyleType = "none";
            for (var peer = 0; peer < currClass.Peers.length; peer++) {
                var thisPeer = currClass.Peers[peer];
                var peerItem = document.createElement("li");
                peerItem.textContent = thisPeer.Realname;
                peerItem.id = "peer" + thisPeer.Username;
                peerItem.className = "peerItem";
                peers.appendChild(peerItem);
            }
            classDiv.appendChild(peers);
            if (currClass.IsFirst) {
                $('#firstSem').append(classDiv);
            }
            else {
                $("#secondSem").append(classDiv);
            }
        }
        $('.peerItem').click(function () {
            var reg = new RegExp("^peer");
            var base = "http://classfinder.me/Schedule/" + escape($(this).attr("id").replace(reg, "")).replace('/', "%2F");
            if(!isMobile) {
                window.location.href = base;
            }
            else {
                window.location.href = base + "/mobile";
            }
        });
    }
</script>
@if (ViewBag.Mobile)
{
    <br/><br/>
    <a href="~/Account/Logout"><h2>Logout</h2></a>
}